<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EV Charging Status</title>
  <link href="https://fonts.googleapis.com/css?family=Orbitron:wght@700" rel="stylesheet" />
  <style>
    body {
      background: #202020;
      color: #fff;
      font-family: 'Orbitron', Arial, sans-serif;
      text-align: center;
    }
    h1 {
      font-size: 3rem;
      margin: 30px 0 30px 0;
      letter-spacing: 2px;
    }
    .car-emoji {
      font-size: 2.3rem;
      vertical-align: middle;
      margin-right: 8px;
    }
    form {
      margin-bottom: 30px;
      font-size: 1.6rem;
    }
    input, button {
      font-family: 'Orbitron', Arial, sans-serif;
      font-size: 1.2rem;
      padding: 7px 10px;
      margin: 10px 8px;
      border-radius: 6px;
      border: none;
      outline: none;
    }
    button {
      background: #fff;
      color: #202020;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #ff4444;
      color: #fff;
    }
    table {
      margin: 0 auto;
      min-width: 90%;
      border-collapse: collapse;
      font-size: 2rem;
    }
    th, td {
      padding: 18px 15px;
      text-align: center;
    }
    th {
      background: #111;
      color: #fff;
      font-size: 2rem;
      letter-spacing: 1px;
    }
    tr {
      background: #2a2a2a;
      transition: background 0.3s;
    }
    tr:nth-child(even) {
      background: #242424;
    }
    .delete-btn {
      background: #b20000;
      color: #fff;
      padding: 10px 25px;
      border-radius: 7px;
      border: none;
      font-size: 1.5rem;
      font-family: 'Orbitron', Arial, sans-serif;
      cursor: pointer;
      font-weight: 700;
      transition: background 0.2s;
    }
    .delete-btn:hover {
      background: #ff4444;
    }
  </style>
</head>
<body>
  <h1><span class="car-emoji">ðŸš—</span>EV Charging Status</h1>
  <form id="chargeForm">
    <label>Name: <input id="name" required /></label>
    <label>Hours: <input id="hours" type="number" step="0.1" min="0" required /></label>
    <button type="submit">Submit</button>
  </form>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Start</th>
        <th>End</th>
        <th>Left</th>
        <th>Delete</th>
      </tr>
    </thead>
    <tbody id="chargeTable"></tbody>
  </table>
  <script>
    // ====== CONFIG ======
    const API_URL = "https://script.google.com/macros/s/AKfycbx8h_wfJt1BKBoVZxZR1fA7qz-rywHQmwovDaKTnZ2nFrEtgcvp1gs_7wyGiD9P115NdQ/exec";
    // ====================

    let interval;

    function fetchTable() {
      fetch(API_URL)
        .then(res => res.json())
        .then(updateTable)
        .catch(() => updateTable([]));
    }

    function updateTable(rows) {
      const tbody = document.getElementById('chargeTable');
      tbody.innerHTML = '';
      clearInterval(interval);

      if (!rows.length) return;

      rows.forEach(row => {
        const tr = document.createElement('tr');

        // Use Date.parse to ensure valid date
        let startDate = row.start ? new Date(row.start) : null;
        let endDate = row.end ? new Date(row.end) : null;
        let validStart = startDate && !isNaN(startDate);
        let validEnd = endDate && !isNaN(endDate);

        function formatDate(d) {
          if (!d || isNaN(d)) return "";
          // Show local time
          return d.toLocaleString();
        }

        // Time left
        let leftCell = document.createElement('td');
        if (validEnd) {
          leftCell.textContent = formatTimeLeft(endDate - new Date());
        } else {
          leftCell.textContent = '';
        }

        // Delete button
        const deleteCell = document.createElement('td');
        const delBtn = document.createElement('button');
        delBtn.className = 'delete-btn';
        delBtn.textContent = "Delete";
        delBtn.onclick = () => {
          if (confirm("Delete this entry?")) {
            fetch(API_URL, {
              method: "DELETE",
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: new URLSearchParams({ name: row.name })
            }).then(fetchTable);
          }
        };
        deleteCell.appendChild(delBtn);

        tr.innerHTML = `
          <td>${row.name || ""}</td>
          <td>${validStart ? formatDate(startDate) : ""}</td>
          <td>${validEnd ? formatDate(endDate) : ""}</td>
        `;
        tr.appendChild(leftCell);
        tr.appendChild(deleteCell);
        tbody.appendChild(tr);
      });

      // Live update "Time Left"
      interval = setInterval(() => {
        Array.from(tbody.children).forEach((tr, i) => {
          let row = rows[i];
          let endDate = row.end ? new Date(row.end) : null;
          let cell = tr.children[3];
          if (endDate && !isNaN(endDate)) {
            cell.textContent = formatTimeLeft(endDate - new Date());
          } else {
            cell.textContent = '';
          }
        });
      }, 1000);
    }

    function formatTimeLeft(ms) {
      if (ms <= 0) return "Expired";
      let s = Math.floor(ms / 1000);
      let h = Math.floor(s / 3600); s %= 3600;
      let m = Math.floor(s / 60); s %= 60;
      let out = [];
      if (h) out.push(h + "h");
      if (m) out.push(m + "m");
      out.push(s + "s");
      return out.join(" ");
    }

    // ===== SUBMIT FORM =====
    document.getElementById('chargeForm').onsubmit = function(e) {
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const hours = document.getElementById('hours').value.trim();
      if (!name || isNaN(Number(hours)) || Number(hours) <= 0) {
        alert("Please enter a valid name and positive number of hours.");
        return;
      }
      fetch(API_URL, {
        method: "POST",
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ name, hours })
      }).then(() => {
        fetchTable();
        document.getElementById('chargeForm').reset();
      });
    };

    // Initial fetch
    fetchTable();
    setInterval(fetchTable, 60000); // Poll for new data every minute
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EV Charging Status</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: #222;
      color: #fff;
      font-family: 'Orbitron', Arial, sans-serif;
    }
    h1 {
      text-align: center;
      font-family: 'Orbitron', Arial, sans-serif;
      font-size: 2.8rem;
      font-weight: 700;
      margin: 40px 0 25px 0;
    }
    .form-row {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 36px;
      gap: 18px;
    }
    label {
      font-size: 1.25rem;
    }
    input[type="text"], input[type="number"] {
      font-size: 1.25rem;
      padding: 8px 14px;
      border-radius: 5px;
      border: 1px solid #444;
      width: 220px;
      font-family: 'Orbitron', Arial, sans-serif;
      background: #eee;
      color: #222;
    }
    button, input[type="submit"] {
      font-family: 'Orbitron', Arial, sans-serif;
      font-size: 1.2rem;
      padding: 7px 26px;
      border-radius: 7px;
      background: #fff;
      color: #222;
      font-weight: bold;
      border: 1.5px solid #fff;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    button.delete-btn {
      background: #b00000;
      color: #fff;
      border: none;
      padding: 7px 20px;
    }
    table {
      margin: 0 auto;
      width: 90%;
      border-collapse: collapse;
      background: #19191a;
      box-shadow: 0 2px 10px #1115;
      font-size: 1.25rem;
    }
    th, td {
      padding: 16px 6px;
      text-align: center;
      border-bottom: 1px solid #333;
    }
    th {
      background: #111;
      color: #fff;
      font-size: 1.28rem;
      font-weight: 700;
    }
    tr:nth-child(even) td {
      background: #232325;
    }
    tr:hover td {
      background: #343439;
    }
  </style>
</head>
<body>
  <h1>EV Charging Status</h1>
  <form id="charge-form" autocomplete="off">
    <div class="form-row">
      <label for="name">Name:</label>
      <input id="name" type="text" required>
      <label for="hours">Hours:</label>
      <input id="hours" type="number" min="0.1" step="0.1" required>
      <input type="submit" value="Submit">
    </div>
  </form>

  <table id="charge-table">
    <thead>
      <tr>
        <th>Name</th>
        <th>Start</th>
        <th>End</th>
        <th>Left</th>
        <th>Delete</th>
      </tr>
    </thead>
    <tbody>
      <!-- data rows go here -->
    </tbody>
  </table>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbx8h_wfJt1BKBoVZxZR1fA7qz-rywHQmwovDaKTnZ2nFrEtgcvp1gs_7wyGiD9P115NdQ/exec';

    // Parse ISO date or return "--"
    function formatDate(iso) {
      if (!iso) return "--";
      let d = new Date(iso);
      if (isNaN(d.getTime())) return "--";
      // "7/19 09:14"
      return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2, "0")}:${String(d.getMinutes()).padStart(2,"0")}`;
    }

    function formatTimeLeft(ms) {
      if (ms <= 0) return "Done";
      let sec = Math.floor(ms / 1000);
      let h = Math.floor(sec / 3600);
      let m = Math.floor((sec % 3600) / 60);
      let s = sec % 60;
      return `${h}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    }

    function buildTable(data) {
      const tbody = document.querySelector("#charge-table tbody");
      tbody.innerHTML = "";

      // sort by end time (soonest first)
      data.sort((a,b) => new Date(a.end) - new Date(b.end));

      data.forEach(row => {
        let tr = document.createElement("tr");
        // Name
        let tdName = document.createElement("td");
        tdName.textContent = row.name;
        tr.appendChild(tdName);

        // Start
        let tdStart = document.createElement("td");
        tdStart.textContent = formatDate(row.start);
        tr.appendChild(tdStart);

        // End
        let tdEnd = document.createElement("td");
        tdEnd.textContent = formatDate(row.end);
        tr.appendChild(tdEnd);

        // Left (live countdown)
        let tdLeft = document.createElement("td");
        tdLeft.className = "left-count";
        tdLeft.setAttribute('data-end', row.end);
        tr.appendChild(tdLeft);

        // Delete
        let tdDel = document.createElement("td");
        let btn = document.createElement("button");
        btn.className = "delete-btn";
        btn.textContent = "Delete";
        btn.onclick = () => deleteRow(row.name, row.start);
        tdDel.appendChild(btn);
        tr.appendChild(tdDel);

        tbody.appendChild(tr);
      });
      updateCountdowns();
    }

    function updateCountdowns() {
      const now = Date.now();
      document.querySelectorAll(".left-count").forEach(td => {
        const endIso = td.getAttribute('data-end');
        let end = Date.parse(endIso);
        if (!isNaN(end)) {
          td.textContent = formatTimeLeft(end - now);
        } else {
          td.textContent = "--";
        }
      });
    }
    setInterval(updateCountdowns, 1000);

    // Load table from backend
    async function loadTable() {
      let res = await fetch(API_URL);
      let data = await res.json();
      // Data may be in raw array form, convert if so:
      if (Array.isArray(data) && Array.isArray(data[0])) {
        // First row is header, skip it
        let headers = data[0].map(h => h.toLowerCase());
        data = data.slice(1).map(row =>
          Object.fromEntries(row.map((v,i) => [headers[i], v]))
        );
      }
      buildTable(data);
    }

    // Add entry
    document.getElementById('charge-form').onsubmit = async function(e) {
      e.preventDefault();
      let name = document.getElementById("name").value.trim();
      let hours = parseFloat(document.getElementById("hours").value);
      if (!name || isNaN(hours)) return alert("Enter valid name and hours.");
      let params = new URLSearchParams({ name, hours });
      let res = await fetch(API_URL, { method: "POST", body: params });
      await loadTable();
      document.getElementById("name").value = "";
      document.getElementById("hours").value = "";
    };

    // Delete by name + start time
    async function deleteRow(name, start) {
      if (!confirm("Delete this row?")) return;
      let payload = JSON.stringify({ name, start });
      await fetch(API_URL, {
        method: "DELETE",
        body: payload,
        headers: { "Content-Type": "application/json" }
      });
      loadTable();
    }

    // Initial load
    loadTable();
  </script>
</body>
</html>
